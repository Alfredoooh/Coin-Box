workflows:
  react-native-android-fixed:
    name: React Native Android - OTIMIZADO E SEGURO v2
    max_build_duration: 60
    environment:
      vars:
        WORKING_DIRECTORY: "coin-box"
      node: latest
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $WORKING_DIRECTORY/node_modules
    scripts:
      - name: Install dependencies
        script: |
          cd "$WORKING_DIRECTORY"
          npm install --no-audit --no-fund
          npm install --save-dev @react-native-community/cli@latest --no-audit

      - name: Expo prebuild (android)
        script: |
          cd "$WORKING_DIRECTORY"
          rm -rf android
          npx expo prebuild --platform android --clean

      - name: Substituir build.gradle otimizado
        script: |
          cd "$WORKING_DIRECTORY"
          cat > android/app/build.gradle <<'EOFGRADLE'
          apply plugin: "com.android.application"
          apply plugin: "org.jetbrains.kotlin.android"
          apply plugin: "com.facebook.react"

          def projectRoot = rootDir.getAbsoluteFile().getParentFile().getAbsolutePath()

          react {
              def entryFileScript = ["node", "-e", "require('expo/scripts/resolveAppEntry')", projectRoot, "android", "absolute"].execute(null, rootDir)
              entryFileScript.waitFor()
              if (entryFileScript.exitValue() == 0) {
                  entryFile = file(entryFileScript.text.trim())
              } else {
                  entryFile = file("$projectRoot/index.js")
              }
              
              reactNativeDir = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
              hermesCommand = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"
              codegenDir = new File(["node", "--print", "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
              
              enableBundleCompression = true
              bundleCommand = "export:embed"
              
              cliFile = new File(["node", "--print", "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"].execute(null, rootDir).text.trim())
              autolinkLibrariesWithApp()
          }

          android {
              ndkVersion rootProject.ext.ndkVersion
              buildToolsVersion rootProject.ext.buildToolsVersion
              compileSdk rootProject.ext.compileSdkVersion
              namespace "com.nexa.cbox"

              defaultConfig {
                  applicationId "com.nexa.cbox"
                  minSdk 24
                  targetSdk rootProject.ext.targetSdkVersion
                  versionCode 1
                  versionName "1.0"
                  buildConfigField("boolean", "IS_NEW_ARCHITECTURE_ENABLED", "false")
              }

              signingConfigs {
                  debug {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                      crunchPngs true
                      zipAlignEnabled true
                      debuggable false
                      jniDebuggable false
                      proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"
                  }
              }
              
              splits {
                  abi {
                      enable true
                      reset()
                      include 'arm64-v8a'
                      universalApk false
                  }
              }

              packagingOptions {
                  jniLibs {
                      useLegacyPackaging false
                  }
                  resources {
                      excludes += [
                          'META-INF/**',
                          '**/*.kotlin_module',
                          '**/*.version',
                          '**/*.properties',
                          'kotlin/**',
                          'DebugProbesKt.bin',
                          'okhttp3/internal/publicsuffix/publicsuffixes.gz'
                      ]
                  }
                  pickFirst 'lib/*/libc++_shared.so'
                  pickFirst 'lib/*/libfbjni.so'
                  pickFirst 'lib/*/libjsi.so'
              }
          }

          dependencies {
              implementation("com.facebook.react:react-android")
              implementation("com.facebook.react:hermes-android")
          }
          EOFGRADLE

      - name: Criar proguard-rules.pro COMPLETO
        script: |
          cd "$WORKING_DIRECTORY"
          cat > android/app/proguard-rules.pro <<'PROGUARDEOF'
          # ========================================
          # REGRAS PROGUARD SEGURAS PARA REACT NATIVE + EXPO
          # ========================================
          
          # Manter atributos essenciais
          -keepattributes *Annotation*
          -keepattributes Signature
          -keepattributes Exceptions
          -keepattributes InnerClasses
          -keepattributes EnclosingMethod
          -keepattributes SourceFile,LineNumberTable
          
          # ========================================
          # REACT NATIVE - CRÃTICO
          # ========================================
          -keep class com.facebook.react.** { *; }
          -keep class com.facebook.hermes.** { *; }
          -keep class com.facebook.jni.** { *; }
          -keep class com.facebook.soloader.** { *; }
          
          # TurboModules e Fabric
          -keep class com.facebook.react.turbomodule.** { *; }
          -keep class com.facebook.react.fabric.** { *; }
          -keep class com.facebook.react.uimanager.** { *; }
          -keep class com.facebook.react.bridge.** { *; }
          -keep class com.facebook.react.modules.** { *; }
          
          # ViewManagers customizados
          -keep class * extends com.facebook.react.uimanager.ViewManager { *; }
          -keep class * extends com.facebook.react.bridge.ReactContextBaseJavaModule { *; }
          -keep class * implements com.facebook.react.bridge.NativeModule { *; }
          
          # ========================================
          # EXPO - CRÃTICO
          # ========================================
          -keep class expo.modules.** { *; }
          -keep class com.swmansion.** { *; }
          -keep interface expo.modules.** { *; }
          
          # Expo modules especÃ­ficos
          -keep class expo.modules.core.interfaces.Package { *; }
          -keep class * implements expo.modules.core.interfaces.Package { *; }
          
          # ========================================
          # JSI (JavaScript Interface)
          # ========================================
          -keep class com.facebook.jsi.** { *; }
          
          # ========================================
          # COIL (Image Loading) - FIX DO ERRO
          # ========================================
          -keep class coil.** { *; }
          -keep class coil3.** { *; }
          -keep interface coil.** { *; }
          -keep interface coil3.** { *; }
          -dontwarn coil.**
          -dontwarn coil3.**
          
          # ========================================
          # REACT NATIVE LIBRARIES COMUNS
          # ========================================
          # React Native Screens
          -keep class com.swmansion.rnscreens.** { *; }
          
          # React Native Gesture Handler
          -keep class com.swmansion.gesturehandler.** { *; }
          
          # React Native Reanimated
          -keep class com.swmansion.reanimated.** { *; }
          
          # React Native SVG
          -keep class com.horcrux.svg.** { *; }
          
          # React Native Vector Icons
          -keep class com.oblador.vectoricons.** { *; }
          
          # React Native WebView
          -keep class com.reactnativecommunity.webview.** { *; }
          
          # React Native Safe Area Context
          -keep class com.th3rdwave.safeareacontext.** { *; }
          
          # ========================================
          # JAVASCRIPT TO NATIVE BRIDGE
          # ========================================
          -keepclassmembers class * {
              @com.facebook.react.uimanager.annotations.ReactProp <methods>;
              @com.facebook.react.uimanager.annotations.ReactPropGroup <methods>;
          }
          
          -keepclassmembers class * {
              @com.facebook.react.bridge.ReactMethod <methods>;
          }
          
          # ========================================
          # REFLECTION - Usado por React Native
          # ========================================
          -keepclassmembers class * {
              public <init>(...);
          }
          
          # ========================================
          # WARNINGS - Suprimir avisos conhecidos
          # ========================================
          -dontwarn com.facebook.react.**
          -dontwarn com.facebook.hermes.**
          -dontwarn okhttp3.**
          -dontwarn okio.**
          -dontwarn javax.annotation.**
          -dontwarn com.google.android.gms.**
          -dontwarn org.conscrypt.**
          
          # ========================================
          # OTIMIZAÃ‡Ã•ES SEGURAS
          # ========================================
          # Remove logs apenas em produÃ§Ã£o (seguro)
          -assumenosideeffects class android.util.Log {
              public static *** d(...);
              public static *** v(...);
          }
          
          # MantÃ©m nomes de classes de erro para debug
          -keepnames class * extends java.lang.Exception
          
          # ========================================
          # OUTRAS BIBLIOTECAS COMUNS
          # ========================================
          # OkHttp
          -keep class okhttp3.** { *; }
          -keep interface okhttp3.** { *; }
          
          # Gson (se usar)
          -keep class com.google.gson.** { *; }
          -keep class * implements com.google.gson.TypeAdapter
          
          # Kotlin
          -keep class kotlin.** { *; }
          -keep class kotlinx.** { *; }
          
          # Coroutines
          -keepnames class kotlinx.coroutines.internal.MainDispatcherFactory {}
          -keepnames class kotlinx.coroutines.CoroutineExceptionHandler {}
          -keepclassmembers class kotlinx.coroutines.** {
              volatile <fields>;
          }
          
          # ========================================
          # NATIVE LIBRARIES
          # ========================================
          -keep class * {
              native <methods>;
          }
          
          # ========================================
          # SERIALIZAÃ‡ÃƒO (se usar com AsyncStorage, etc)
          # ========================================
          -keepclassmembers class * implements java.io.Serializable {
              private static final java.io.ObjectStreamField[] serialPersistentFields;
              private void writeObject(java.io.ObjectOutputStream);
              private void readObject(java.io.ObjectInputStream);
              java.lang.Object writeReplace();
              java.lang.Object readResolve();
          }
          PROGUARDEOF

      - name: Corrigir MainApplication.kt
        script: |
          cd "$WORKING_DIRECTORY"
          cat > android/app/src/main/java/com/nexa/cbox/MainApplication.kt <<'EOFKOTLIN'
          package com.nexa.cbox
          
          import android.app.Application
          import android.content.res.Configuration
          import expo.modules.ApplicationLifecycleDispatcher
          import expo.modules.ReactNativeHostWrapper
          import com.facebook.react.PackageList
          import com.facebook.react.ReactApplication
          import com.facebook.react.ReactNativeHost
          import com.facebook.react.ReactPackage
          import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint.load
          import com.facebook.react.defaults.DefaultReactNativeHost
          import com.facebook.soloader.SoLoader
          
          class MainApplication : Application(), ReactApplication {
            override val reactNativeHost: ReactNativeHost = ReactNativeHostWrapper(
              this,
              object : DefaultReactNativeHost(this) {
                override fun getPackages(): List<ReactPackage> {
                  val packages = PackageList(this).packages
                  return packages
                }
          
                override fun getJSMainModuleName(): String = ".expo/.virtual-metro-entry"
          
                override fun getUseDeveloperSupport(): Boolean = false
          
                override val isNewArchEnabled: Boolean = false
                override val isHermesEnabled: Boolean = true
              }
            )
          
            override fun onCreate() {
              super.onCreate()
              SoLoader.init(this, false)
              load()
              ApplicationLifecycleDispatcher.onApplicationCreate(this)
            }
          
            override fun onConfigurationChanged(newConfig: Configuration) {
              super.onConfigurationChanged(newConfig)
              ApplicationLifecycleDispatcher.onConfigurationChanged(this, newConfig)
            }
          }
          EOFKOTLIN

      - name: Testar bundle ANTES do build
        script: |
          cd "$WORKING_DIRECTORY"
          echo "ðŸ§ª === TESTANDO BUNDLE JAVASCRIPT ==="
          
          mkdir -p /tmp/test-bundle
          
          npx expo export:embed \
            --platform android \
            --bundle-output /tmp/test-bundle/index.android.bundle \
            --assets-dest /tmp/test-bundle \
            --dev false
          
          if [ $? -eq 0 ]; then
            echo "âœ… Bundle criado com sucesso!"
            echo "ðŸ“¦ Tamanho do bundle:"
            du -h /tmp/test-bundle/index.android.bundle
          else
            echo "âŒ ERRO ao criar bundle!"
            exit 1
          fi

      - name: Build APK otimizado
        script: |
          cd "$WORKING_DIRECTORY/android"
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon --stacktrace -Dorg.gradle.jvmargs="-Xmx4096m" --no-build-cache

      - name: Verificar tamanho e copiar APK
        script: |
          cd "$WORKING_DIRECTORY"
          echo "==> APKs gerados:"
          ls -lh android/app/build/outputs/apk/release/*.apk
          
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*arm64-v8a-release.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          fi
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ Erro: Nenhum APK encontrado!"
            exit 1
          fi
          
          mkdir -p "$CM_BUILD_DIR"
          cp "$APK_PATH" "$CM_BUILD_DIR/app-release.apk"
          
          echo "==> âœ… Tamanho final do APK:"
          du -h "$CM_BUILD_DIR/app-release.apk"

    artifacts:
      - $CM_BUILD_DIR/*.apk
    publishing:
      email:
        recipients:
          - seu-email@example.com
        notify:
          success: true
          failure: true