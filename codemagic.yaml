workflows:
  react-native-android-minimal-apk:
    name: React Native Android APK Build
    max_build_duration: 60
    environment:
      vars:
        WORKING_DIRECTORY: "coin-box"
      node: latest
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $WORKING_DIRECTORY/node_modules
    scripts:
      - name: Install dependencies
        script: |
          cd "$WORKING_DIRECTORY"
          npm install --no-audit --no-fund

      - name: Install expo-build-properties
        script: |
          cd "$WORKING_DIRECTORY"
          npx expo install expo-build-properties

      - name: Configurar app.json com otimizações
        script: |
          cd "$WORKING_DIRECTORY"
          cat > app.json <<'APPJSON'
          {
            "expo": {
              "name": "Coin Box",
              "slug": "coin-box",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#ffffff"
              },
              "android": {
                "package": "com.nexa.cbox",
                "adaptiveIcon": {
                  "foregroundImage": "./assets/icon.png",
                  "backgroundColor": "#ffffff"
                },
                "jsEngine": "hermes",
                "versionCode": 1
              },
              "ios": {
                "bundleIdentifier": "com.nexa.cbox"
              },
              "plugins": [
                [
                  "expo-build-properties",
                  {
                    "android": {
                      "enableProguardInReleaseBuilds": true,
                      "enableShrinkResourcesInReleaseBuilds": true,
                      "extraProguardRules": "-keep class com.facebook.** { *; }\n-keep class expo.** { *; }\n-dontwarn okhttp3.**"
                    }
                  }
                ]
              ]
            }
          }
          APPJSON

      - name: Expo prebuild (android)
        script: |
          cd "$WORKING_DIRECTORY"
          rm -rf android
          npx expo prebuild --platform android --clean

      - name: Forçar arm64-v8a apenas
        script: |
          cd "$WORKING_DIRECTORY"
          BUILD_GRADLE="android/app/build.gradle"
          
          awk '/defaultConfig \{/{print; print "        ndk { abiFilters \"arm64-v8a\" }"; next}1' "$BUILD_GRADLE" > tmp && mv tmp "$BUILD_GRADLE"
          
          echo "==> Verificando ndk:"
          grep -A 2 "ndk {" "$BUILD_GRADLE" || echo "NDK não encontrado"

      - name: Build APK otimizado
        script: |
          cd "$WORKING_DIRECTORY/android"
          chmod +x ./gradlew
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon

      - name: Verificar tamanho e copiar APK
        script: |
          cd "$WORKING_DIRECTORY"
          echo "==> APKs gerados:"
          ls -lh android/app/build/outputs/apk/release/*.apk
          
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "Erro: Nenhum APK encontrado!"
            exit 1
          fi
          
          mkdir -p "$CM_BUILD_DIR"
          cp "$APK_PATH" "$CM_BUILD_DIR/app-release.apk"
          
          echo "==> Tamanho do APK:"
          du -h "$CM_BUILD_DIR/app-release.apk"

    artifacts:
      - $CM_BUILD_DIR/*.apk
    publishing:
      email:
        recipients:
          - seu-email@example.com
        notify:
          success: true
          failure: true