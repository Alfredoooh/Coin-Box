workflows:
  react-native-android-minimal-apk:
    name: React Native Android APK Build
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      vars:
        WORKING_DIRECTORY: "coin-box"
      node: 20.11.0
      java: 17
    cache:
      cache_paths:
        - $HOME/.gradle/caches
        - $WORKING_DIRECTORY/node_modules
    scripts:
      - name: Install dependencies
        script: |
          cd "$WORKING_DIRECTORY"
          npm install --no-audit --no-fund

      - name: Expo prebuild (android)
        script: |
          cd "$WORKING_DIRECTORY"
          rm -rf android
          npx expo prebuild --platform android --clean

      - name: Configurar ProGuard
        script: |
          cd "$WORKING_DIRECTORY"
          cat > android/app/proguard-rules.pro <<'EOF'
          # React Native
          -keep class com.facebook.react.** { *; }
          -keep class com.facebook.hermes.** { *; }
          
          # Expo
          -keep class expo.modules.** { *; }
          
          # App
          -keep class com.nexa.cbox.** { *; }
          
          # WebView
          -keep class com.reactnativecommunity.webview.** { *; }
          -keep class android.webkit.** { *; }
          -keepattributes JavascriptInterface
          
          # React Native Reanimated
          -keep class com.swmansion.reanimated.** { *; }
          -keep class com.th3rdwave.safeareacontext.** { *; }
          
          # Warnings
          -dontwarn com.facebook.**
          -dontwarn okhttp3.**
          -dontwarn okio.**
          
          # OtimizaÃ§Ãµes bÃ¡sicas
          -keepattributes *Annotation*
          -optimizationpasses 2
          -dontpreverify
          EOF

      - name: Patch build.gradle
        script: |
          cd "$WORKING_DIRECTORY/android/app"
          
          # Criar novo build.gradle com Python
          python3 << 'PYTHON_EOF'
          import re
          
          with open('build.gradle', 'r') as f:
              content = f.read()
          
          # Adicionar configuraÃ§Ã£o de ABIs para build mais rÃ¡pido (sÃ³ arm64-v8a para teste)
          if 'ndk {' not in content:
              android_block = re.search(r'(android\s*\{)', content)
              if android_block:
                  insert_pos = android_block.end()
                  ndk_config = '''
      defaultConfig {
          ndk {
              abiFilters "arm64-v8a"
          }
      }
  '''
                  content = content[:insert_pos] + ndk_config + content[insert_pos:]
          
          # Encontrar e substituir buildTypes
          pattern = r'(buildTypes\s*\{[^}]*release\s*\{)(.*?)(\})'
          
          def replace_release(match):
              release_block = match.group(2)
              # Remover minifyEnabled e shrinkResources existentes
              release_block = re.sub(r'minifyEnabled\s+(true|false)', '', release_block)
              release_block = re.sub(r'shrinkResources\s+(true|false)', '', release_block)
              
              # Adicionar configuraÃ§Ãµes corretas
              new_config = '''
              minifyEnabled false
              shrinkResources false
              proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
          '''
              return match.group(1) + new_config + release_block + match.group(3)
          
          content = re.sub(pattern, replace_release, content, flags=re.DOTALL)
          
          with open('build.gradle', 'w') as f:
              f.write(content)
          
          print("âœ“ build.gradle atualizado")
          PYTHON_EOF
          
          echo "=== Verificando configuraÃ§Ã£o ==="
          grep -A 15 "release {" build.gradle

      - name: Build APK
        script: |
          cd "$WORKING_DIRECTORY/android"
          
          # Configurar gradle.properties para performance
          cat >> gradle.properties << 'GRADLE_PROPS'
          
          # Performance
          org.gradle.jvmargs=-Xmx6g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
          org.gradle.parallel=true
          org.gradle.daemon=false
          org.gradle.configureondemand=true
          android.enableJetifier=true
          android.useAndroidX=true
          
          # Build apenas arm64-v8a
          reactNativeArchitectures=arm64-v8a
          GRADLE_PROPS
          
          # Limpar builds anteriores
          ./gradlew clean --no-daemon
          
          # Build SIMPLIFICADO - sÃ³ info quando necessÃ¡rio
          ./gradlew assembleRelease \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=1g" \
            2>&1 | tee /tmp/gradle-build.log
          
          BUILD_STATUS=${PIPESTATUS[0]}
          
          if [ $BUILD_STATUS -ne 0 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ BUILD FALHOU"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ” ERROS ENCONTRADOS:"
            grep -i "error\|exception\|failed\|FAILURE" /tmp/gradle-build.log | tail -100
            echo ""
            echo "ğŸ“‹ ÃšLTIMAS 200 LINHAS:"
            tail -200 /tmp/gradle-build.log
            exit 1
          fi
          
          echo "âœ“ Build concluÃ­do com sucesso!"

      - name: Verificar e copiar APK
        script: |
          cd "$WORKING_DIRECTORY"
          
          echo "=== Procurando APKs ==="
          find android/app/build/outputs -name "*.apk" -type f
          
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" -type f | head -1)
          
          if [ -z "$APK_PATH" ]; then
            echo "âŒ ERRO: Nenhum APK encontrado!"
            echo "Estrutura de diretÃ³rios:"
            ls -R android/app/build/outputs/
            exit 1
          fi
          
          mkdir -p "$CM_BUILD_DIR"
          cp "$APK_PATH" "$CM_BUILD_DIR/coin-box.apk"
          
          echo ""
          echo "âœ“ APK copiado com sucesso!"
          echo "Tamanho: $(du -h "$CM_BUILD_DIR/coin-box.apk" | cut -f1)"
          echo "Path: $APK_PATH"

    artifacts:
      - $CM_BUILD_DIR/*.apk
      
    publishing:
      email:
        recipients:
          - alfredoooh.x3@gmail.com
        notify:
          success: true
          failure: true
